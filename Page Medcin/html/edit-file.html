<!DOCTYPE html>
<html lang="fr">
<head>
    <link rel="stylesheet" href="style.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modifier un Dossier Médical - Medcin Manager</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-clinic-medical me-2"></i>Medcin Manager
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">
                            <i class="fas fa-home me-1"></i>Tableau de bord
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="profile.html">
                            <i class="fas fa-user-md me-1"></i>Mon Profil
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="medical-files.html">
                            <i class="fas fa-folder-open me-1"></i>Dossiers Médicaux
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="medications.html">
                            <i class="fas fa-pills me-1"></i>Médicaments
                        </a>
                    </li>
                </ul>
                <div class="d-flex">
                    <div class="dropdown">
                        <button class="btn btn-light dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-user-circle me-1"></i>Dr. Martin
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton">
                            <li><a class="dropdown-item" href="profile.html">Mon profil</a></li>
                            <li><a class="dropdown-item" href="#">Paramètres</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="login.html"><i class="fas fa-sign-out-alt me-1"></i>Déconnexion</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>
    <!-- Main Content -->
    <div class="container mt-4">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="index.html">Accueil</a></li>
                <li class="breadcrumb-item"><a href="medical-files.html">Dossiers Médicaux</a></li>
                <li class="breadcrumb-item active" aria-current="page">Modifier un Dossier</li>
            </ol>
        </nav>

        <!-- Page Title -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h2 mb-0">
                    <i class="fas fa-edit me-2 text-primary"></i>Modifier un Dossier Médical
                </h1>
                <p class="text-muted">Mettez à jour les informations du patient et son dossier médical</p>
            </div>
        </div>

        <!-- Form Card -->
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">Informations du Patient</h5>
            </div>
            <div class="card-body">
                <form id="editMedicalFileForm">
                    <input type="hidden" id="fileId" value="">

                    <!-- Patient Information Section -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="border-bottom pb-2 mb-3">Informations Personnelles</h6>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="patientFirstName" class="form-label">Prénom <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="patientFirstName" required>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="patientLastName" class="form-label">Nom <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="patientLastName" required>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="patientDob" class="form-label">Date de naissance <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="patientDob" required>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="patientGender" class="form-label">Sexe <span class="text-danger">*</span></label>
                            <select class="form-select" id="patientGender" required>
                                <option value="">Sélectionner</option>
                                <option value="M">Masculin</option>
                                <option value="F">Féminin</option>
                                <option value="O">Autre</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="patientId" class="form-label">Numéro d'identification <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="patientId" required>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="patientBloodType" class="form-label">Groupe sanguin</label>
                            <select class="form-select" id="patientBloodType">
                                <option value="">Sélectionner</option>
                                <option value="A+">A+</option>
                                <option value="A-">A-</option>
                                <option value="B+">B+</option>
                                <option value="B-">B-</option>
                                <option value="AB+">AB+</option>
                                <option value="AB-">AB-</option>
                                <option value="O+">O+</option>
                                <option value="O-">O-</option>
                            </select>
                        </div>
                    </div>

                    <!-- Contact Information Section -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="border-bottom pb-2 mb-3">Coordonnées</h6>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="patientPhone" class="form-label">Téléphone <span class="text-danger">*</span></label>
                            <input type="tel" class="form-control" id="patientPhone" required>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="patientEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="patientEmail">
                        </div>
                        
                        <div class="col-12 mb-3">
                            <label for="patientAddress" class="form-label">Adresse <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="patientAddress" rows="2" required></textarea>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="patientEmergencyContact" class="form-label">Contact d'urgence</label>
                            <input type="text" class="form-control" id="patientEmergencyContact">
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="patientEmergencyPhone" class="form-label">Téléphone d'urgence</label>
                            <input type="tel" class="form-control" id="patientEmergencyPhone">
                        </div>
                    </div>

                    <!-- Medical Information Section -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="border-bottom pb-2 mb-3">Informations Médicales</h6>
                        </div>
                        
                        <div class="col-md-12 mb-3">
                            <label for="patientAllergies" class="form-label">Allergies</label>
                            <textarea class="form-control" id="patientAllergies" rows="2"></textarea>
                        </div>
                        
                        <div class="col-md-12 mb-3">
                            <label for="patientChronicDiseases" class="form-label">Maladies chroniques</label>
                            <textarea class="form-control" id="patientChronicDiseases" rows="2"></textarea>
                        </div>
                        
                        <div class="col-md-12 mb-3">
                            <label for="patientMedications" class="form-label">Médicaments actuels</label>
                            <textarea class="form-control" id="patientMedications" rows="2"></textarea>
                        </div>
                        
                        <div class="col-md-12 mb-3">
                            <label for="patientMedicalHistory" class="form-label">Antécédents médicaux</label>
                            <textarea class="form-control" id="patientMedicalHistory" rows="3"></textarea>
                        </div>
                    </div>

                    <!-- Medical Notes Section -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="border-bottom pb-2 mb-3">Notes Médicales</h6>
                        </div>
                        
                        <div class="col-12">
                            <div class="card mb-3 bg-light">
                                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">Ajouter une note médicale</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="noteDate" class="form-label">Date de consultation</label>
                                        <input type="date" class="form-control" id="noteDate" value="">
                                    </div>
                                    <div class="mb-3">
                                        <label for="noteContent" class="form-label">Observations et diagnostic</label>
                                        <textarea class="form-control" id="noteContent" rows="4"></textarea>
                                    </div>
                                    <button type="button" class="btn btn-primary btn-sm" id="addNoteBtn">
                                        <i class="fas fa-plus me-1"></i>Ajouter une note
                                    </button>
                                </div>
                            </div>
                            
                            <div id="medicalNotesContainer">
                                <!-- Les notes médicales seront ajoutées ici dynamiquement -->
                                <div class="alert alert-info" id="noNotesAlert">
                                    <i class="fas fa-info-circle me-2"></i>Aucune note médicale n'a été ajoutée pour ce patient.
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Form Buttons -->
                    <div class="row">
                        <div class="col-12 d-flex justify-content-between">
                            <a href="medical-files.html" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-1"></i>Retour
                            </a>
                            <div>
                                <button type="button" class="btn btn-danger me-2" data-bs-toggle="modal" data-bs-target="#deleteConfirmModal">
                                    <i class="fas fa-trash-alt me-1"></i>Supprimer
                                </button>
                                <button type="submit" class="btn btn-primary" id="saveChangesBtn">
                                    <i class="fas fa-save me-1"></i>Enregistrer les modifications
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteConfirmModalLabel">Confirmation de suppression</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-0">Êtes-vous sûr de vouloir supprimer définitivement ce dossier médical ? Cette action est irréversible.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                        <i class="fas fa-trash-alt me-1"></i>Supprimer définitivement
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Toast -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 5">
        <div id="successToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas fa-check-circle me-2"></i>Le dossier médical a été mis à jour avec succès.
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Get patient ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            const patientId = urlParams.get('id');
            
            if (!patientId) {
                // Redirect to medical files page if no ID is provided
                window.location.href = 'medical-files.html';
                return;
            }
            
            // Set the hidden field value
            document.getElementById('fileId').value = patientId;
            
            // Fetch patient data (simulate with sample data for this example)
            fetchPatientData(patientId);
            
            // Handle form submission
            const form = document.getElementById('editMedicalFileForm');
            form.addEventListener('submit', function(event) {
                event.preventDefault();
                savePatientData();
            });
            
            // Add note button event listener
            document.getElementById('addNoteBtn').addEventListener('click', addMedicalNote);
            
            // Delete confirmation button event listener
            document.getElementById('confirmDeleteBtn').addEventListener('click', deletePatientFile);
        });
        
        // Simulate fetching patient data from server
        function fetchPatientData(patientId) {
            // In a real application, this would be an API call
            // For this example, we're using mock data
            const mockPatient = {
                id: patientId,
                firstName: "Jean",
                lastName: "Dupont",
                dob: "1985-06-15",
                gender: "M",
                bloodType: "O+",
                phone: "06 12 34 56 78",
                email: "jean.dupont@email.com",
                address: "123 Rue de la Santé, 75000 Paris",
                emergencyContact: "Marie Dupont (Épouse)",
                emergencyPhone: "06 98 76 54 32",
                allergies: "Pénicilline, Aspirine",
                chronicDiseases: "Hypertension, Diabète type 2",
                medications: "Lisinopril 10mg (1 comprimé/jour), Metformine 500mg (2 comprimés/jour)",
                medicalHistory: "Appendicectomie (2005)\nFracture du bras droit (2012)",
                notes: [
                    {
                        id: 1,
                        date: "2023-11-10",
                        content: "Patient se plaint de maux de tête persistants. Tension artérielle élevée (150/95). Ajustement du traitement pour l'hypertension."
                    },
                    {
                        id: 2,
                        date: "2023-10-05",
                        content: "Contrôle du diabète. Glycémie à jeun: 130 mg/dL. Maintien du traitement actuel. Conseils nutritionnels donnés."
                    }
                ]
            };
            
            // Populate form with patient data
            populateForm(mockPatient);
            
            // Display medical notes
            displayMedicalNotes(mockPatient.notes);
        }
        
        // Fill form with patient data
        function populateForm(patient) {
            document.getElementById('patientFirstName').value = patient.firstName;
            document.getElementById('patientLastName').value = patient.lastName;
            document.getElementById('patientDob').value = patient.dob;
            document.getElementById('patientGender').value = patient.gender;
            document.getElementById('patientId').value = patient.id;
            document.getElementById('patientBloodType').value = patient.bloodType;
            document.getElementById('patientPhone').value = patient.phone;
            document.getElementById('patientEmail').value = patient.email;
            document.getElementById('patientAddress').value = patient.address;
            document.getElementById('patientEmergencyContact').value = patient.emergencyContact;
            document.getElementById('patientEmergencyPhone').value = patient.emergencyPhone;
            document.getElementById('patientAllergies').value = patient.allergies;
            document.getElementById('patientChronicDiseases').value = patient.chronicDiseases;
            document.getElementById('patientMedications').value = patient.medications;
            document.getElementById('patientMedicalHistory').value = patient.medicalHistory;
            
            // Set today's date for the new note
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('noteDate').value = today;
        }
        
        // Display medical notes
        function displayMedicalNotes(notes) {
            const container = document.getElementById('medicalNotesContainer');
            const noNotesAlert = document.getElementById('noNotesAlert');
            
            if (notes && notes.length > 0) {
                // Hide the "no notes" alert
                noNotesAlert.style.display = 'none';
                
                // Clear existing notes
                // Keep the alert as the first child and remove everything else
                while (container.children.length > 1) {
                    container.removeChild(container.lastChild);
                }
                
                // Add notes in reverse chronological order (newest first)
                notes.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                notes.forEach(note => {
                    const noteCard = document.createElement('div');
                    noteCard.className = 'card mb-3';
                    noteCard.dataset.noteId = note.id;
                    
                    // Format the date
                    const noteDate = new Date(note.date);
                    const formattedDate = noteDate.toLocaleDateString('fr-FR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric'
                    });
                    
                    noteCard.innerHTML = `
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-calendar-day me-2"></i>${formattedDate}</span>
                            <div>
                                <button type="button" class="btn btn-sm btn-outline-danger delete-note-btn" data-note-id="${note.id}">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <p class="card-text">${note.content.replace(/\n/g, '<br>')}</p>
                        </div>
                    `;
                    
                    container.appendChild(noteCard);
                    
                    // Add event listener to delete button
                    const deleteBtn = noteCard.querySelector('.delete-note-btn');
                    deleteBtn.addEventListener('click', function() {
                        deleteNote(note.id);
                    });
                });
            } else {
                // Show the "no notes" alert
                noNotesAlert.style.display = 'block';
            }
        }
        
        // Add a new medical note
        function addMedicalNote() {
            const dateInput = document.getElementById('noteDate');
            const contentInput = document.getElementById('noteContent');
            
            const date = dateInput.value;
            const content = contentInput.value.trim();
            
            if (!date || !content) {
                alert('Veuillez remplir tous les champs de la note médicale.');
                return;
            }
            
            // Generate a unique ID for the note (in a real app, this would come from the server)
            const noteId = Date.now();
            
            // Create a new note object
            const newNote = {
                id: noteId,
                date: date,
                content: content
            };
            
            // Get existing notes from the DOM
            const notes = [];
            const container = document.getElementById('medicalNotesContainer');
            const noteCards = container.querySelectorAll('.card[data-note-id]');
            
            noteCards.forEach(card => {
                const id = parseInt(card.dataset.noteId);
                const dateText = card.querySelector('.card-header span').textContent;
                const contentText = card.querySelector('.card-body p').innerHTML.replace(/<br>/g, '\n');
                
                notes.push({
                    id: id,
                    date: extractDateFromFormattedString(dateText),
                    content: contentText
                });
            });
            
            // Add the new note
            notes.push(newNote);
            
            // Update the display
            displayMedicalNotes(notes);
            
            // Clear the inputs
            contentInput.value = '';
            
            // Show success message
            alert('Note médicale ajoutée avec succès.');
        }
        
        // Helper function to extract date from formatted string
        function extractDateFromFormattedString(formattedDate) {
            // Extract date from string like "15/04/2023"
            const matches = formattedDate.match(/(\d{2})\/(\d{2})\/(\d{4})/);
            if (matches) {
                return `${matches[3]}-${matches[2]}-${matches[1]}`;
            }
            return new Date().toISOString().split('T')[0]; // Fallback to today
        }
        
        // Delete a medical note
        function deleteNote(noteId) {
            if (confirm('Êtes-vous sûr de vouloir supprimer cette note médicale ?')) {
                const container = document.getElementById('medicalNotesContainer');
                const noteCard = container.querySelector(`.card[data-note-id="${noteId}"]`);
                
                if (noteCard) {
                    noteCard.remove();
                    
                    // Check if there are any notes left
                    const remainingNotes = container.querySelectorAll('.card[data-note-id]');
                    if (remainingNotes.length === 0) {
                        document.getElementById('noNotesAlert').style.display = 'block';
                    }
                    
                    // Show success message
                    alert('Note médicale supprimée avec succès.');
                }
            }
        }
        
        // Save patient data
        function savePatientData() {
            // In a real application, this would send the data to the server
            // For this example, we're just simulating success
            
            // Get all form values
            const patientData = {
                id: document.getElementById('fileId').value,
                firstName: document.getElementById('patientFirstName').value,
                lastName: document.getElementById('patientLastName').value,
                dob: document.getElementById('patientDob').value,
                gender: document.getElementById('patientGender').value,
                bloodType: document.getElementById('patientBloodType').value,
                phone: document.getElementById('patientPhone').value,
                email: document.getElementById('patientEmail').value,
                address: document.getElementById('patientAddress').value,
                emergencyContact: document.getElementById('patientEmergencyContact').value,
                emergencyPhone: document.getElementById('patientEmergencyPhone').value,
                allergies: document.getElementById('patientAllergies').value,
                chronicDiseases: document.getElementById('patientChronicDiseases').value,
                medications: document.getElementById('patientMedications').value,
                medicalHistory: document.getElementById('patientMedicalHistory').value
            };
            
            // Collect notes from the DOM
            const notes = [];
            const container = document.getElementById('medicalNotesContainer');
            const noteCards = container.querySelectorAll('.card[data-note-id]');
            
            noteCards.forEach(card => {
                const id = parseInt(card.dataset.noteId);
                const dateText = card.querySelector('.card-header span').textContent;
                const contentText = card.querySelector('.card-body p').innerHTML.replace(/<br>/g, '\n');
                
                notes.push({
                    id: id,
                    date: extractDateFromFormattedString(dateText),
                    content: contentText
                });
            });
            
            patientData.notes = notes;
            
            // Log the data that would be sent to the server
            console.log('Saving patient data:', patientData);
            
            // Show success toast
            const toast = new bootstrap.Toast(document.getElementById('successToast'));
            toast.show();
            
            // In a real app, you might redirect to the medical files list after saving
            // setTimeout(() => window.location.href = 'medical-files.html', 2000);
        }
        
        // Delete patient file
        function deletePatientFile() {
            // In a real application, this would send a delete request to the server
            // For this example, we'll just redirect to the medical files page
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal'));
            modal.hide();
            
            // Show success alert
            alert('Le dossier médical a été supprimé avec succès.');
            
            // Redirect to medical files list
            window.location.href = 'medical-files.html';
        }
    </script>
</body>
</html>